<main>
  <section class="users-section">
    <h1>Список користувачів</h1>
    <div class="filters-container">
      <div class="search-container">
        <input
          type="text"
          placeholder="Пошук користувачів..."
          (input)="onSearchChange($event)"
        >
      </div>
      <div class="select-filters">
        <select (change)="onFilterChange('role', $event.target.value)">
          <option value="all">Всі ролі</option>
          <option value="User">Користувач</option>
          <option value="Employee">Працівник</option>
        </select>
        <select (change)="onFilterChange('department', $event.target.value)">
          <option value="all">Всі відділи</option>
          <option value="personal">Особисті</option>
          <option value="finance">Фінанси</option>
        </select>
      </div>
    </div>
    <div class="table-container">
      <table>
        <thead>
        <tr>
          <th>Логін</th>
          <th>ПІБ</th>
          <th>Роль</th>
          <th>Відділ</th>
          <th>Дії</th>
        </tr>
        </thead>
        <tbody>
          @for (user of filteredUsers(); track user.id) {
            <tr>
              <td>{{ user.login }}</td>
              <td>{{ user.firstName }} {{ user.lastName }}</td>
              <td>{{ translateRole(user.role) }}</td>
              <td class="department-cell">
                @if (user.role === 'Employee') {
                  <select
                    [ngModel]="user.department?.id"
                    (ngModelChange)="changeDepartment(user.id, $event)"
                    class="department-select"
                  >
                    @if (!user.department) {
                      <option value="" disabled>Оберіть відділ</option>
                    }
                    @for (dept of departments(); track dept.id) {
                      <option [value]="dept.id" [selected]="dept.id === user.department?.id">
                        {{ dept.name }}
                      </option>
                    }
                  </select>
                } @else {
                  -
                }
              </td>
              <td class="actions">
                @if (user.role !== 'Employee') {
                  <button
                    class="action-button"
                    (click)="initiateRoleChange(user.id, 'Employee')"
                  >
                    Зробити працівником
                  </button>
                } @else {
                  <button
                    class="action-button"
                    (click)="initiateRoleChange(user.id, 'User')"
                  >
                    Зробити користувачем
                  </button>
                }
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
    <div class="pagination">
      <button
        [disabled]="!hasPreviousPage()"
        (click)="onPageChange(currentPage() - 1)"
      >
        &lt;-
      </button>
      @for (page of [].constructor(totalPages()); track $index) {
        <button
          [class.active]="currentPage() === ($index + 1)"
          (click)="onPageChange($index + 1)"
        >
          {{ $index + 1 }}
        </button>
      }
      <button
        [disabled]="!hasNextPage()"
        (click)="onPageChange(currentPage() + 1)"
      >
        -&gt;
      </button>
    </div>
  </section>

  @if (roleChangeModal().show) {
    <div class="modal-overlay">
      <div class="modal">
        <h2>Підтвердження зміни ролі</h2>
        @if (roleChangeModal().newRole === 'Employee') {
          <div class="department-selection">
            <p>Оберіть відділ для нового працівника:</p>
            <select [(ngModel)]="selectedDepartment">
              <option value="">Оберіть відділ</option>
              @for (dept of roleChangeModal().departments; track dept.id) {
                <option [value]="dept.id">{{ dept.name }}</option>
              }
            </select>
          </div>
        } @else {
          <p>Ви впевнені, що хочете змінити роль цього користувача на звичайного користувача?</p>
          <p>Користувач втратить доступ до відділу та пов'язані з ним можливості.</p>
        }
        <div class="modal-actions">
          <button
            class="action-button"
            (click)="confirmRoleChange()"
            [disabled]="roleChangeModal().newRole === 'Employee' && !selectedDepartment"
          >
            Підтвердити
          </button>
          <button class="cancel-button" (click)="cancelRoleChange()">
            Скасувати
          </button>
        </div>
      </div>
    </div>
  }
</main>
